<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>invenTI - Inventario TI - FelipheGomez</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/2.2.1/vue-router.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.15.3/axios.js"></script>
		<link href="dist/bootstrap/4.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap-theme.min.css">
        <style>
        .logo {
          width: 50px;
          float: left;
          margin-right: 15px;
        }

        .form-group {
          max-width: 500px;
        }

        .actions {
          padding: 10px 0;
        }

        .glyphicon-euro {
          font-size: 12px;
        }
        </style>
    </head>
<body>

<div class="" id="app"><div class=""></div></div>

<template id="post-list">
  <div>
        <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-secondary">
            <form class="navbar-nav mr-auto form-inline">
                <input v-model="searchKey" class="form-control" id="search-element" requred/>
            </form>  
            <ul class="navbar-nav mt-2 mt-md-0">
              <router-link tag="li" class="nav-item" v-bind:to="{path: '/add-post'}">
              <a class="nav-link">
                <span class="glyphicon glyphicon-plus"></span>
                Add article
              </a>
              </router-link>
            </ul>
        </nav>
      <div class="container">
        <div class="actions">
        </div>
        <table class="table">
          <thead>
          <tr>
            <th>ID</th>
            <th width="20%">Categoria</th>
            <th width="60%">Content</th>
            <th class="col-sm-2">Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr v-if="posts===null">
            <td colspan="4">Cargando...</td>
          </tr>
          <tr v-else v-for="post in filteredposts">
            <td>{{ post.id }}</td>
            <td>{{ post.category_id.name }}</td>
            <td>
              <router-link v-bind:to="{name: 'post', params: {post_id: post.id}}">{{ post.content }}</router-link>
            </td>
            <td>
              <router-link class="btn btn-warning btn-xs" v-bind:to="{name: 'post-edit', params: {post_id: post.id}}">Edit</router-link>
              <router-link class="btn btn-danger btn-xs" v-bind:to="{name: 'post-delete', params: {post_id: post.id}}">Delete</router-link>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
  </div>
</template>

<template id="add-post">
  <div>
        <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-secondary">
            <form class="navbar-nav mr-auto form-inline">
            </form>  
            <ul class="navbar-nav mt-2 mt-md-0">
              <router-link tag="li" class="nav-item" v-bind:to="{path: '/'}">
              <a class="nav-link">
                <span class="glyphicon glyphicon-plus"></span>
                Volver
              </a>
              </router-link>
            </ul>
        </nav>
      <div class="container">
        <h2>Add new article</h2>
        <form v-on:submit="createpost">
          <div class="form-group">
            <label for="edit-content">Categoria: </label>
            <select v-model="post.category_id">
              <option v-for="option in options" v-bind:value="option.id">
                {{ option.name }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-content">Content</label>
            <textarea class="form-control" id="add-content" rows="10" v-model="post.content"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Create</button>
          <router-link class="btn btn-default" v-bind:to="'/'">Cancel</router-link>
        </form>
      </div>
  </div>
</template>

<template id="post">
    <div>
        <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-secondary">
            <form class="navbar-nav mr-auto form-inline">
            </form>  
            <ul class="navbar-nav mt-2 mt-md-0">
              <router-link tag="li" class="nav-item" v-bind:to="{path: '/'}">
              <a class="nav-link">
                <span class="glyphicon glyphicon-plus"></span>
                Volver
              </a>
              </router-link>
            </ul>
        </nav>
      <div class="container">
        <div class="col-sm-12">
            <h2>Categoria: {{ post.category_id.name }}</h2>
            <hr>
            <p>{{ post.content }}</p>
            <table class="table">
                <tr v-for="serial in post.article_serials">
                    <td>{{ serial.name }}</td>
                    <td>{{ serial.serial }}</td>
                </tr>
            </table>
            <hr>
            <h2>Revisiones: </h2>
            <table class="table">
                <tr v-for="comment in post.comments">
                    <td>{{ comment.message }}</td>
                </tr>
            </table>
            <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
            <router-link v-bind:to="'/'">Back to post list</router-link>
        </div>
      </div>
    </div>
</template>

<template id="post-edit">
  <div>
        <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-secondary">
            <form class="navbar-nav mr-auto form-inline">
            </form>  
            <ul class="navbar-nav mt-2 mt-md-0">
              <router-link tag="li" class="nav-item" v-bind:to="{path: '/'}">
              <a class="nav-link">
                <span class="glyphicon glyphicon-plus"></span>
                Volver
              </a>
              </router-link>
            </ul>
        </nav>
        <div class="container">
            <h2>Editar Articulo</h2>
            <div class="row">
                <div class="col-sm-6">
                    <form v-on:submit="updatepost">
                      <div class="form-group">
                        <label for="edit-content">Content: </label>
                        <select v-model="selected">
                          <option v-for="option in options" v-bind:value="option.id">
                            {{ option.name }}
                          </option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="edit-content">Categoria: </label>
                        <textarea class="form-control" id="edit-content" rows="3" v-model="post.content"></textarea>
                      </div>
                      <button type="submit" class="btn btn-primary">Guardar</button>
                      <router-link class="btn btn-default" v-bind:to="'/'">Cancel</router-link>
                    </form>
                </div>
                <div class="col-sm-6">
                    <h4>Seriales: <a class="btn btn-success btn-xs"> + </a></h4>
                    <table class="table">
                        <tr v-for="serial in post.article_serials">
                            <td>{{ serial.name }}</td>
                            <td>{{ serial.serial }}</td>
                            <td>
                              <a class="btn btn-warning btn-xs">Edit</a>
                              <a class="btn btn-danger btn-xs">Delete</a>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-sm-12">
                    <h4>Revisiones: <a class="btn btn-success btn-xs"> + </a></h4>
                    <table class="table">
                        <tr v-for="comment in post.comments">
                            <td>{{ comment.message }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
  </div>
</template>

<template id="post-delete">
  <div>
        <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-secondary">
            <form class="navbar-nav mr-auto form-inline">
            </form>  
            <ul class="navbar-nav mt-2 mt-md-0">
              <router-link tag="li" class="nav-item" v-bind:to="{path: '/'}">
              <a class="nav-link">
                <span class="glyphicon glyphicon-plus"></span>
                Volver
              </a>
              </router-link>
            </ul>
        </nav>
      <div class="container">
        <h2>Delete article {{ post.id }}</h2>
        <form v-on:submit="deletepost">
          <p>The action cannot be undone.</p>
          <button type="submit" class="btn btn-danger">Delete</button>
          <router-link class="btn btn-default" v-bind:to="'/'">Cancel</router-link>
        </form>
      </div>
  </div>
</template>



<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://unpkg.com/popper.js/dist/umd/popper.min.js"></script>
<script src="dist/bootstrap/4.1.3/dist/js/bootstrap.min.js"></script>

<script>
var posts = null;

var api = axios.create({
  baseURL: '/mv/InvenTI/api/api.php/records'
});

function findpost (postId) {
  return posts[findpostKey(postId)];
};

function findpostKey (postId) {
  for (var key = 0; key < posts.length; key++) {
    if (posts[key].id == postId) {
      return key;
    }
  }
};

var List = Vue.extend({
  template: '#post-list',
  data: function () {
    return {
        posts: posts,
        searchKey: this.$parent.searchKey
    };
  },
  mounted: function () {
    var self = this;
    
    api.get('/articles?join=categories&join=comments&join=serials', {
        params: {
            
        }
    }).then(function (response) {
        posts = self.posts = response.data.records;
    }).catch(function (error) {
        console.log(error);
    });
  },
  computed: {
    filteredposts: function () {
      return this.posts.filter(function (post) {
        return this.searchKey=='' || post.content.indexOf(this.searchKey) !== -1;
      },this);
    }
  }
});

var post = Vue.extend({
  template: '#post',
  data: function () {
    return {post: findpost(this.$route.params.post_id)};
  }
});

var postEdit = Vue.extend({
  template: '#post-edit',
  data: function () {
    return {
        post: findpost(this.$route.params.post_id),
        selected: '',
        options: this.$parent.categories
    };
  },
    created(){
        var self = this;
        
        self.selected = self.post.category_id.id;
        
    },
  methods: {
    updatepost: function () {
        var item = {
            id: this.post.id,
            category_id: this.selected,
            content: this.post.content,
        };
        
        api.put('/articles/'+item.id,item).then(function (response) {
            console.log(response.data);
        }).catch(function (error) {
            console.log(error);
        });
        router.push('/');
    }
  }
});

var postDelete = Vue.extend({
  template: '#post-delete',
  data: function () {
    return {post: findpost(this.$route.params.post_id)};
  },
  methods: {
    deletepost: function () {
      var post = this.post;
      api.delete('/articles/'+post.id).then(function (response) {
        console.log(response.data);
      }).catch(function (error) {
        console.log(error);
      });
      router.push('/');
    }
  }
});

var Addpost = Vue.extend({
  template: '#add-post',
  data: function () {
    return {
        options: this.$parent.categories,
        post: {
            content: '', 
            category_id: 0,
        }
    }
  },
  methods: {
    createpost: function() {
      var post = this.post;
      api.post('/articles',post).then(function (response) {
        console.log(response);
        post.id = response.data;
      }).catch(function (error) {
        console.log(error);
      });
      router.push('/');
    }
  },
    created(){
        var self = this;
    }
});

var router = new VueRouter({routes:[
  { path: '/', component: List},
  { path: '/post/:post_id', component: post, name: 'post'},
  { path: '/add-post', component: Addpost},
  { path: '/post/:post_id/edit', component: postEdit, name: 'post-edit'},
  { path: '/post/:post_id/delete', component: postDelete, name: 'post-delete'}
]});
app = new Vue({
    el: "#app",
    data: {
        posts: null,
        categories: null,
        searchKey: ''
    },
	components: {
        'List': List
	},
    router:router,
    methods: {
    },
    created() {
    },
    mounted() {
        var self = this;
        api.get('/categories').then(function (response) {
            self.categories = response.data.records
        }).catch(function (error) {
            console.log(error);
        });
    },
    template: `
    <main class="container_not">
        <router-view></router-view>
    </main>
    `
})
</script>

</body>
</html>
